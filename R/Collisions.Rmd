Exploratory Analysis of Seattle Collisions by Leah Erb
============================================================

This report explores **collision** reports from **Seattle, Washington, USA**.

# The Dataset
The [Seattle Collisions](https://data-seattlecitygis.opendata.arcgis.com/datasets/collisions) dataset is a compilation of over 200,000 collision reports created by Seattle Police Department (SPD) that were then recorded by Seattle Department of Transportation (SDOT), between the years 2004 and 2018.

```{r echo=FALSE, message=FALSE, warning=FALSE, Libraries}
#
# Setup programming environment
#

# libraries
library(data.table) # for renaming columns
library(stringr)   # for 'word' function
library(ggpubr)    # for 'ggarrange' function
library(ggplot2)
library(scales)
library(GGally)    # for ggcorr function
library(dplyr)
library(tidyverse)
library(knitr)
library(psych)
library(reshape2)  
library(cowplot)
library(gridExtra)

# global settings
knitr::opts_chunk$set(comment=NA, fig.width=9, fig.height=6)

# ggplot layers
mylayer_color <- scale_color_brewer(palette='Dark2', direction = 1)  
mylayer_fillcolor <- scale_fill_brewer(palette='Dark2', direction = 1)
mylayer_x90 <- theme(axis.text.x=element_text(angle=90, hjust=1))
mylayer_hour_breaks <- scale_x_datetime(labels = date_format("%H:%M"), date_breaks = ('2 hours')) 
mylayer_long_xlabel <- theme(axis.text.x=element_text(angle=90, hjust=1)) 
mylayer_count_above <- geom_text(stat = 'count', aes(label = ..count..), vjust = -.2)
```


```{r echo=FALSE, warning=FALSE, message=FALSE, Load_data}
#
# Load data
#

# manually toggle datafile as local or live source
datafile = 'Collisions.csv'
#datafile = 'http://data-seattlecitygis.opendata.arcgis.com/datasets/5b5c745e0f1f48e7a53acec63a0022ab_0.csv'

# import empty strings as NULL
df_raw = read.csv(datafile, na.strings=c(""," "), header=TRUE)
# df = working dataset (to be cleaned); df_raw = data as loaded
df <- data.frame(df_raw)
```

# Assess raw data

```{r}
glimpse(df_raw)
```

#### What are the min and max date / timestamps?
```{r}
# min
subset(df, as.Date(df$INCDATE) == min(as.Date(df$INCDATE)), c(INCDATE,INCDTTM))
# max
subset(df, as.Date(df$INCDATE) == max(as.Date(df$INCDATE)), c(INCDATE,INCDTTM))
```

#### Which columns have NULL values?
```{r}
# helper function, print columns with null value(s) and their counts
count_nulls <- function(this_df) {
  df_nulls <- sapply(df, function(x) sum(is.na(x)))
  as.data.frame(df_nulls[df_nulls>0]) %>% rename_at(1, ~'null_count')
}

count_nulls(df_raw)
```
**Observation:** date and datetime columns have no NULL values.

#### A few columns have only 1 record with a NULL value, are they all from the same record?
```{r}
cols <-  c('SEVERITYCODE','SDOT_COLCODE','SDOT_COLDESC','COLLISIONTYPE')
subset(df, is.na(SEVERITYCODE) | is.na(SDOT_COLCODE) | is.na(SDOT_COLDESC), cols)
```
**Observation:** No.

#### Can we deduce a value for the NULL SDOT_COLCODE, given other values in the record?
```{r}
subset(df, is.na(SDOT_COLCODE))
```
**Observation:** No. There is very little information recorded. Interestingly, this record was the first recorded. It may have been a test insert? 


#### Can we deduce a value for the NULL SEVERITYCODE, given other values in the record?
```{r}
df[is.na(df$SEVERITYCODE),]
```
**Observation:** The NULL SEVERITYCODE could be changed to '0' because INJURY, SERIOUSINJURIES and FATALITIES = 0

#### What do Date/Time columns look like?
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Dates and Times
writeLines('INCDATE ...')
head(df$INCDATE, 20)
writeLines('INCDTTM ...')
head(df$INCDTTM, 20)
```

#### What do binary-esque columns look like?
```{r}
# Helper function to return value frequency of given column.
count_pct <- function(df) {
  return(
    df %>% 
      tally() %>% 
      mutate(freq = (n_pct = n / sum(n)))
  )
}
```

```{r}
# Show count and % of column values
cols <- c('UNDERINFL', 'INATTENTIONIND', 'SPEEDING', 'HITPARKEDCAR')
lapply(df[cols], function(x) {
  x <- enquo(x)
  df %>% group_by(fct_explicit_na(!! x)) %>% count_pct
  })
```

#### For counts-of-things columns, what % of values are > 0?
```{r}
cols <- c('PERSONCOUNT','PEDCOUNT','PEDCYLCOUNT','VEHCOUNT',
          'INJURIES','SERIOUSINJURIES','FATALITIES')
as.data.frame(lapply(df[,cols], 
                     function(x){
                       length(which(x!=0))/length(x) *100
                       } 
                     ))
```

###\ Assessment Observations
**May require cleaning:**

* INCDATE is a factor with format 'YYYY-MM-DDT00:00:00.000Z'
* INCDTTM is a factor with varying formats of 'M/DD/YY HH:MM' and 'M/DD/YY'
* Minimum INCDATE = '2003-10-06T00:00:00.000Z'
* SEVERITYCODE, SDOT_COLCODE and SDOT_COLDESC: each have only 1 NULL value. 
  * The SEVERITYCODE=NA could be marked '0' instead because INJURY, SERIOUSINJURIES and FATALITIES = 0
  * The only incident with no SDOT_COLCODE is also the first record (by timestamp). It may be a test insert.
* SDOT_COLCODE contains categorical data but is datatype Integer.
* Binary fields: 
  * INATTENTIONIND appears to default to NULL unless specifically set to 'Y'. ( >86% NULL)
  * SPEEDING       appears to default to NULL unless specifically set to 'Y'. (>95% NULL)
  * HITPARKEDCAR has no NULLs, all values are 'N' or 'Y'. (>95% 'N')
  * UNDERINFL is all over the map, with 0, 1, N, Y and NULL values. (> 95% 0, N or NULL)
* Some key columns may not be of use in our analysis since we not, at this time,
  joining with other tables: -OBJECTID, -REPORTNO, -STATUS, -EXCEPTRSNCODE, 
  -EXCEPTRSNDESC, -COLDETKEY, -INCKEY, -INTKEY, -SDOTCOLNUM, -SEGLANEKEY
  

**Of interest:**

*  more than 88% collisions have non-zero values for PERSONCOUNT and VEHCOUNT

*  fewer than 28% collisions have non-zero values INJURIES

*  fewer than 5% of PEDCOUNT, PEDCYLCOUNT, SERIOUSINJURIES and FATALITIES are non-zero values



#\
Clean 

### Date/Time columns

* Change INCDATE datatype to Date

* Create date/time columns:
    + Year (YYYY)
    + Month (1-12)
    + Time (HH:MM)
    + Hour (of day)
    + DayPart (Morning, Afternoon, Evening, Night)
    + Season (Spring, Summer, Fall, Winter)
    
```{r echo=FALSE, warning=FALSE, message=FALSE, Clean_data}
# convert INCDATE to date datatype
df$INCDATE <- as.Date(df$INCDATE)

# create year and month columns
df$Year <- as.factor(lubridate::year(as.Date(df$INCDATE)))
df$Month <- as.factor(lubridate::month(as.Date(df$INCDATE)))

# trim records so all dates are part of a complete year's worth of reports
# TODO: move this to reporting logic where it makes sense to trim
#max(df$INCDATE)
#df <- subset(df, Year < 2019 & Year > 2003)

# create Time and Hour columns
df$Time <- as.POSIXct(word(df$INCDTTM, 2), format='%H:%M')
df$Hour <- as.integer(substr(df$Time, 12, 13))

# categorize time of day 
df$DayPart <- factor(with(df,
     ifelse(Hour >= 6 & Hour < 12, 'Morning',
     ifelse(Hour >= 12 & Hour < 17, 'Afternoon',
     ifelse(Hour >= 17 & Hour < 20, 'Evening',
     ifelse(Hour >= 20 | Hour < 6, 'Night',
            'Unknown'))))))

# categorize Season
df$Season <- factor(with(df,
     ifelse(Month %in% c('3','4','5'), 'Spring', 
     ifelse(Month %in% c('6','7','8'), 'Summer', 
     ifelse(Month %in% c('9','10','11'), 'Fall', 
     ifelse(Month %in% c('12','1','2'), 'Winter', 
            'Unknown'))))))
```

### Simplify and standardize

* Rename columns
  + UNDERINFL -> DUI
  + INATTENTIONID -> DISTRACTED
* Group common SDOTtypes (e.g., combine multiple '%Sideswipe%' types into one named 'Sideswipe')
* Shorten SEVERITYDESC values by removing ' Collision' from strings
* Clean binary variables so all values are either Y or N. Change NULL to N by default, meaning that the attribute was NOT (='N') marked as a feature of the collision
* Change SEVERITYCODE to 0 where NULL
* Change factors to 'Unknown' where NULL (WEATHER, ROADCOND, LIGHTCOND)

```{r echo=FALSE, warning=FALSE, message=FALSE}

## Rename Columns for easier plot reading 
### Footnote:
### I was not convinced I could substitute 'inattentionind' to 'distracted', because there is a subtle difference and I did not want to be misleading. Then I read the WADOT's 2015 Annual Collision Summary, which (unless they are listing the details of the type of inattention/distraction, which are not available in the downloaded dataset), refer to 'inattention' as 'inattention/distraction', every time. This suggests that I can safely substitute 'distracted' for easier reading of this report.

### Also, I was unsure whether I could use the 'DUI' alias for 'UNDERINFL'. In the same report, 'UNDERINFL' is short for 'Under the Influence of Alcohol and/or Drugs' and, without more detailed data available, is lumped together as ' DUI and/or Physical Control of the Vehicle while under the Influence'. 

### References: 
### https://www.wsdot.wa.gov/mapsdata/crash/pdf/2015_Annual_Collision_Summary.pdf
### https://www.seattle.gov/Documents/Departments/SDOT/About/DocumentLibrary/Reports/2017_Traffic_Report.pdf

df <- setnames(df,
         old=c('UNDERINFL', 'INATTENTIONIND'),
         new=c('DUI'      , 'DISTRACTED'),
         skip_absent = TRUE)


# group SDOT collision types into fewer categories.
# (Ref: State Collision Code Directory https://www.seattle.gov/Documents/Departments/SDOT/GIS/Collisions_OD.pdf)
df$SDOTtype <- factor(with(df,
     ifelse(SDOT_COLCODE <= 5, 'Hits Pedestrian', 
     ifelse(SDOT_COLCODE >= 11 & SDOT_COLCODE <= 12, 'Sideswipe', 
     ifelse(SDOT_COLCODE >= 13 & SDOT_COLCODE <= 14, 'Rear End', 
     ifelse(SDOT_COLCODE >= 15 & SDOT_COLCODE <= 23, 'From Same Direction', 
     ifelse(SDOT_COLCODE >= 24 & SDOT_COLCODE <= 25, 'Head On', 
     ifelse(SDOT_COLCODE >= 26 & SDOT_COLCODE <= 27, 'Sideswipe', 
     ifelse(SDOT_COLCODE >= 28 & SDOT_COLCODE <= 30, 'From Opposite Direction', 
     ifelse(SDOT_COLCODE >= 44 & SDOT_COLCODE <= 46, 'Cycle',
     ifelse(SDOT_COLCODE >= 47 & SDOT_COLCODE <= 51, 'Struck Object',
     ifelse(SDOT_COLCODE >= 53 & SDOT_COLCODE <= 57, 'Non-Collision', 
     ifelse(SDOT_COLCODE >= 71 & SDOT_COLCODE <= 72, 'Sideswipe', 
     ifelse(SDOT_COLCODE >= 73 & SDOT_COLCODE <= 74, 'Rear End', 
     ifelse(SDOT_COLCODE >= 81 & SDOT_COLCODE <= 82, 'Sideswipe', 
     ifelse(SDOT_COLCODE >= 83 & SDOT_COLCODE <= 84, 'Rear End', 
            'Other Collision'))))))))))))))))

# shorten SEVERITYDESC values by removing ' Collision' from strings
df$SEVERITYDESC <- as.factor(gsub('* Collision', '\\1', df$SEVERITYDESC))

# make DUI binary (Y/N) 
df$DUI <- as.factor(with(df,
     ifelse(DUI == 'N', 'N', 
     ifelse(DUI == 'Y', 'Y',  
     ifelse(DUI == '0', 'N', 
     ifelse(DUI == '1', 'Y',         
            ''))))))

# binary columns: default NULL to 'N'
cols <- c('DUI','DISTRACTED','SPEEDING','HITPARKEDCAR')
# must change factors to characters before replace_na
df[cols] <- lapply(df[cols], as.character)
# replace NAs with 'N'
df <- df %>%
  mutate_at(vars(DUI, DISTRACTED, SPEEDING, HITPARKEDCAR),
            ~replace_na(., 'N'))
# back to factors
df[cols] <- lapply(df[cols], as.factor)


# factor columns: default NULL to 'Unknown'
cols <- c('WEATHER','ROADCOND','LIGHTCOND', 'COLLISIONTYPE')
# must change factors to characters before replace_na
df[cols] <- lapply(df[cols], as.character)
# replace NAs with 'Unknown'
df <- df %>%
  mutate_at(vars(WEATHER, ROADCOND, LIGHTCOND, COLLISIONTYPE),
            ~replace_na(., 'Unknown'))
# back to factors
df[cols] <- lapply(df[cols], as.factor)



# replace empty strings with 'Unknown'
# TODO double-check this logic now that empty strings are replaced with NA on import
#df$WEATHER <- as.character(df$WEATHER)
#df$WEATHER[df$WEATHER==''] <- 'Unknown'
#df$WEATHER <- as.factor(df$WEATHER)
```


### Fix and trim
* Delete the first record by INCDATE (it appears to have been a test insert)
* Change NULL SEVERITYCODE to 0
* Remove columns not of interest at this time.
```{r}
#
# Fix and Trim
#

# delete first record (by INCDATE)
df <- df %>% filter(INCDATE > min(df$INCDATE))

# change NULL SEVERITYCODE to 0
df$SEVERITYCODE[is.na(df$SEVERITYCODE)] <- 0

# remove columns not of interest at this time
df <- df %>%
  select(-OBJECTID, -REPORTNO, -STATUS, -EXCEPTRSNCODE, -EXCEPTRSNDESC,
         -COLDETKEY, -INCKEY, -INTKEY, -SDOTCOLNUM, -SEGLANEKEY, -CROSSWALKKEY, 
         -PEDROWNOTGRNT, -LOCATION, -HITPARKEDCAR, -ST_COLCODE, -ST_COLDESC,
         -SDOT_COLDESC)

```


### Data structure after cleaning
```{r}
glimpse(df)
count_nulls(df)
```



#\
Univariate Plots

### How have the total number of collisions changed over the years?

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(data = df, aes(x = Year)) +
  geom_bar()  +
  scale_y_continuous(breaks = seq(0, 18000, 2000))

```

The distribution of collision frequency by year appears bimodal, peaking at **2005** and, to a lesser extent, **2015**, with a low at **2010** and again in **2018**. This plot hints at a possible 5-year pattern.

I had expected to see a steady increase in Seattle collisions, mirroring population growth. Perhaps I'm wrong about the steady increase in population, or that the number of **reported** collisions have a strong correlation with the population in the first place.

###\
Do collision frequencies change throughout the day?

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data = df %>% count(Hour), aes(x = Hour, y = n )) + geom_line() + ylim(0,15000)
```

It appears that collision counts tend to rise during commute hours, starting at the lowest point around 4am. 

###\
What are the COLLISION types, according to the **SPD**?

> Our dataset includes 2 Collision type (category) variables: 
>
> 1.  COLLISIONTYPE reported by SPD (Seattle Police Department)
>
> 2.  SDOTtype recorded by SDOT (Seattle Department of Transportation)


```{r echo=FALSE, warning=FALSE, message=FALSE, Univariate_Plots}

ggplot(data = df,
       aes(x = reorder(COLLISIONTYPE, COLLISIONTYPE, function(x) length(x) * -1)  )) +
  geom_bar(width = .95)   +
  mylayer_count_above +
  mylayer_long_xlabel +
  labs(x = 'SPD COLLISIONTYPE', y = 'Count')

```

### \
What are the collision types as recorded by **SDOT**?

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(data = df,
       aes(x = reorder(SDOTtype, SDOTtype, function(x) length(x) * -1))) +
  geom_bar(width = .95)  +
  mylayer_count_above +
  mylayer_long_xlabel +
  labs(x = 'SDOTtype', y = 'Count')

```

\
**SPD** has 11 collision categories while **SDOT**'s has 7. Which type I choose to include in this study could have an impact on our analysis. For example, if we are analyzing collisions involving Pedestrians, SPD reports only 1,770 'Pedestrian', while SDOT reports 'Hits Pedestrian' 17,846 times. That's a nearly 10x difference. Also, SDOT's 'Rear End' count is almost twice as many as SPD's.

It is possible that SPD has reason to categorize collisions differently than SDOT. The reasons are outside the scope of this project. Nonetheless, it would be interesting to look into how Collision types are recorded, and if it would make a differences in our analysis.

In this report, except where otherwise noted, will be using **SDOT**'s Collision categories.

### \
What are the SEVERITY categories?

```{r echo=FALSE, warning=FALSE, message=FALSE}

severity_level_order <- c('Unknown','Property Damage Only', 'Injury', 'Serious Injury', 'Fatality' )

ggplot(df, 
       aes(x = factor(SEVERITYDESC, level = severity_level_order))) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = percent_format()) +
  mylayer_long_xlabel +
  labs(x = 'SEVERITYDESC', y = 'Percent')
  
```

Observations:

* This plot orders the Severity bins in order of worsening severity.

* The frequency of collisions by Severity is right skewed (towards higher severity).

* Over 60% of collisions result in Property Damage Only (no injuries or deaths). 

The Severity factor alone does no quantify the damage done by collisions. We could make a rough attempt to quantify damage by using columns VEHCOUNT, INJURIES, SERIOUSINJURIES and FATALATIES in a calculation, but it would be a crude quantification.


### \
Geographical, environmental and time factors

Let's get a rough idea of how counts are distributed amongst these types of categorical factors. Don't worry about not being able to read the x-axis labels yet :-> .

```{r echo=FALSE, warning=FALSE, message=FALSE}

dfshort <- subset(df, select = 
                    c(ADDRTYPE, JUNCTIONTYPE, WEATHER, LIGHTCOND, ROADCOND, 
                      Season, DayPart),
                  (!is.na(DayPart)))

dfshort_counts <- dfshort %>%
  group_by(ADDRTYPE, JUNCTIONTYPE, WEATHER, LIGHTCOND, ROADCOND, 
                      Season, DayPart) %>%
  summarise(n = n()) 

dfshort_counts.long <-  melt(dfshort_counts, id.vars='n') 

ggplot(data = dfshort_counts.long,
       aes(x = value, y = n)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  facet_wrap(~ variable, scales = 'free_x', ncol=2) 

```

Observations: 

* Location (**AddrType** and **JunctionType**) each have a two predominant types. We might dig into the these two variables later, to see if JunctionType is a subset of AddrType.

* Environmental conditions (**Weather**, **LightCond**, **RoadCond**) each have a dominant categories. Earlier we saw that most collisions happen in the middle of the day, so I suspect that is represented here (Clear, Daylight, Dry).

* Time factor (**Season**, **DayPart**) frequencies a more evenly spread, with the highest frequency in Summer Afternoons.


### \
The **Counts of Things**

These are the quantitative variables, which are simply counts of things. Let's see what they are and how they're spread out.

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a dataframe with a shortlist of columns
dfshort <- subset(df, select = c(VEHCOUNT, PERSONCOUNT, PEDCOUNT, PEDCYLCOUNT, INJURIES, SERIOUSINJURIES, FATALITIES))

dfshort_counts <- dfshort %>%
  group_by(VEHCOUNT, PERSONCOUNT, PEDCOUNT, PEDCYLCOUNT, INJURIES, SERIOUSINJURIES, FATALITIES) %>%
  summarise(n = n()) 

dfshort_counts.long <-  melt(dfshort_counts, id.vars='n') 

ggplot(data = dfshort_counts.long,
       aes(x = value, y = n)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  facet_wrap(~ variable, scales = 'free_x', ncol=2) 

```


#### \
Since many of the **Counts of Things** have 0 value, plot them again but this time with log10 so non-zero values are more visible.
```{r echo=FALSE, message=FALSE, warning=FALSE, CountOfThings}

ggplot(data = dfshort_counts.long,
       aes(x = value, y = n)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  facet_wrap(~ variable, scales = 'free_x', ncol=2) +
  scale_y_log10()

rm(dfshort, dfshort_counts, dfshort_counts.long)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(df[c('VEHCOUNT', 'PERSONCOUNT','PEDCOUNT','PEDCYLCOUNT','INJURIES','SERIOUSINJURIES','FATALITIES')])
```

\
The **Counts of Things** frequencies are all right-skewed. Only the VEHCOUNT and PERSONCOUNT peak at 2 instead of 0.

### \
Let's look closer at Vehicle and Person counts ...

#### VEHCOUNT
"The number of vehicles involved in the collision. This is entered by the state."

```{r echo=FALSE, warning=FALSE, message=FALSE}
p1 <- ggplot(df, 
       aes(x = VEHCOUNT)) +
  geom_bar(aes(y = (..count..) )) +
  scale_x_continuous(breaks = seq(0, 20, 2))

p2 <- ggplot(data = df, aes(x = '', y = VEHCOUNT)) +  geom_boxplot(aes(alpha=.25)) + labs(x = '(boxplot)')

grid.arrange(p1, p2, ncol=2)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}

summary(df$VEHCOUNT)

```

The vast majority of collisions involve 2 vehicles. The mean, median, Q2 and Q3 are all roughly the same (2), as verified with the flat box plot.


#### \
PERSONCOUNT 
"The total number of people involved in the collision"

```{r echo=FALSE, warning=FALSE, message=FALSE}
p1 <- ggplot(df, 
       aes(x = PERSONCOUNT)) +
  geom_bar(aes(y = (..count..) )) +
  scale_x_continuous(breaks = seq(0, 90, 10))

p2 <- ggplot(data = df, aes(x = '', y = PERSONCOUNT)) +  geom_boxplot(aes(alpha=.25)) 

grid.arrange(p1, p2, ncol=2)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
summary(df$PERSONCOUNT)
```

\
Observations:
* Most collisions involve 2 people, the next highest-count being 3 persons. 
* Some reportedly have zero PERSONCOUNT. 
* Median and Q1 are the same (2), with Q3 being just one away, then a very long tail to a maximum of 93. 
* There is no data available to explain the circumstances of the larger PERSONCOUNTs. 


### \
How about driver diminished capacity and error (**DUI**,  **DISTRACTED**, **Speeding**)?

```{r echo=FALSE, message=FALSE, error=FALSE}

pu <- ggplot(df, 
       aes(x = DUI)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = percent_format(), limits=c(0,1)) 

pi <- ggplot(df, 
       aes(x = DISTRACTED)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = percent_format(), limits=c(0,1)) 

ps <- ggplot(df, 
       aes(x = SPEEDING)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = percent_format(), limits=c(0,1)) 

grid.arrange(pu, pi, ps, ncol=3)

rm(pu, pi, ps)

```

\
Observations:

* **DISTRACTED** is reported more often then **DUI**. 

* Surprisingly, **SPEEDING** is infrequently noted in collision reports. 


# \
Univariate Analysis

### What is the structure of your dataset?
There were 205,381 collisions reported by SPD between the years 2004 and 2018.

Most of the variables are categorical, describing:

* environmental factors
* location factors
* points in time

Binary variables (Yes or No) include:

* DISTRACTED 
* DUI
* Speeding

Quantitative variables include counts of: 

* bicycles
* vehicles
* people
* injuries
* fatalities

#### Other observations:

Most collisions:

* happen in a 'block' location (as opposed to intersection or alley)
* involve 2 vehicles
* occur on a clear or partly cloudy day, during daylight on a dry road
* are categorized as a 'Rear End' or 'Sideswipe'
* usually involve property damage only, as opposed to injury or fatality

### What is/are the main feature(s) of interest in your dataset?

The main features of interes include: 

* Time: are there trends across the years, or during an average day?
* DUI: are there patterns to DUI collisions?
* Collision Type: Possible disparities between SPD's and SDOT's classification of collision types.
* Severity: What kind of collisions have higher Severity.

### What other features in the dataset do you think will help support your \
investigation into your feature(s) of interest?  

Counts of Things may help explain possible SPD and SDOT collision classification disparities. 

Counts of Things may also help explain Severity classifications.

Also, geographical and environmental variables may help support the investigation of main features.

### Did you create any new variables from existing variables in the dataset?

Yes. I created point-in-time variables to help make reporting and graphing easier:

* Year
* Season
* Hour
* DayPart (morning, afternoon, etc)

I created a new collision categorical variable (SDOTtype) to group common SDOT's collision types. For example, I combined 6 types of 'Sideswipe' collision types into one category called 'Sideswipe'.


### Of the features you investigated, were there any unusual distributions? \
Did you perform any operations on the data to tidy, adjust, or change the form \
of the data? If so, why did you do this?

I log-transformed the strongly right-skewed **Counts of Things** distributions (vehicles, people, injuries, etc). Both the vehicle and person counts peaked at 2 while all other counts peaked at 0. Person count, injuries and serious injuries have a long right tail. The log10 transformation made it easier to see counts other than the left-side peaks.

Other changes: 

* Original values if DUI included: 0, 1, Y, N and null. In order to standardize the values, I changed 0 to N and 1 to Y.

* I deleted rows with Incident Dates before 2004 or after 2018. Original records outside that range contained only partial-year records.

* There was a single record with a null value for SEVERITYCODE. I first verified there were no counts of injuries or fatalities then set the value to 0. 

* Original WEATHER values included both 'Unknown' and NULL. I standardized by combining both as 'Unknown'.

* Original SEVERITYDESC string values were postfixed with ' Collision', which made labels unnecessarily long, so I removed those postfixes.

* I deleted columns from the dataset that were not of interest for this study (such as report numbers and administrative codes.)

* I renamed two columns for easier programming and plot reading:

+ DUI <- UNDERINFL ("Whether or not a driver involved was under the influence of drugs or alcohol.")
+ DISTRACTED <- INATTENTIONID ("Whether or not collision was due to inattention. (Y/N)")

#\
Bivariate Plots Section


```{r echo=FALSE, message=FALSE, warning=FALSE, Pairs_Panels}

set.seed(1965)
df_samp <- sample_n(df[, c('SEVERITYCODE', 'SDOTtype','COLLISIONTYPE',
                           'ADDRTYPE', 'JUNCTIONTYPE', 'VEHCOUNT', 
                           'PERSONCOUNT', 'DUI','WEATHER','DISTRACTED',
                           'ROADCOND','LIGHTCOND','SPEEDING','DayPart','Hour')], 10000)
pairs.panels(df_samp, gap=0)
rm(df_samp)

```

From this correlation chart, we see moderately strong relationships between:

**DUI* and ...

* Person Count
* Vehicle Count
* Collision Type
* Severity Code
* Weather
* Light Condition 

**Vehicle Count** and ...

* Person Count (which makes sense, the more vehicles the more people)
* Collision Type
* Weather
* Light Condition 

Let's view these stronger correlations in a couple different ways ...

####\
Correlations table

```{r echo=FALSE, message=FALSE, warning=FALSE, Corr_Columns}

# Create temporary df with variables of interest for ggcorr, 
# converting dtypes to integers, rqmt for ggcorr
df2 <- data.frame(lapply(df[, 
                            c('DUI','VEHCOUNT','SEVERITYCODE','COLLISIONTYPE', 
                           'WEATHER','PERSONCOUNT','ROADCOND','LIGHTCOND')],
                  function(x) as.integer(x)))

res <- cor(df2)
round(res, 2)
```


####\
Easy-reference plot

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggcorr(df2, method = c('everything', 'pearson'), label = TRUE, size = 2.5)
rm(df2)
```

\
It is clear that **DUI** and **VEHCOUNT** have the strongest relationships.

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Limit data to records with non-NULL DUI 
dfu <- data.frame(subset(df, DUI %in% c('N','Y')))

```

create_summary <- function(data, col1, col2) {
  col1 <- enquo(col1)
  col2 <- enquo(col2)
  result_summary <- data %>%
    group_by(!! col1, !! col2) %>%
    summarise(count = n()) %>%
    mutate(perc = count/sum(count)) 
  mutate(label = percent(perc %>% round(5))
  
  result_summary
}

```{r echo=FALSE, warning=FALSE, message=FALSE, Create_Summary}
#
# Helper function to return dataframe of count and % of 1 or 2 given factors.
#
create_summary <- function(data, col1, col2) {
  col1 <- enquo(col1)
  col2 <- enquo(col2)
  result_summary <- data %>%
    group_by(!! col1, !! col2) %>%
    summarise(count = n()) %>%
    mutate(perc = count/sum(count),
           label = percent(perc %>% round(5)))
  
  result_summary
}

#
# Helper function to return dataframe of count and % of 2 given factors.
#
create_summary_1d <- function(data, col1) {
  col1 <- enquo(col1)
  result_summary <- data %>%
    group_by(!! col1) %>%
    summarise(count = n()) %>%
    mutate(perc = count/sum(count)) 
  
  result_summary
}

```

### \
COLLISIONTYPE and VEHCOUNT

COLLISIONTYPE and VEHCOUNT have a moderately-strong relationship (.5). Let's see what they look like.

```{r echo=FALSE, warning=FALSE, message=FALSE, CollisionAndVehicleCount}

ggplot(data = create_summary(df, VEHCOUNT, COLLISIONTYPE), 
       aes(x = VEHCOUNT,
           y = perc, 
           fill = factor(COLLISIONTYPE))) +
  scale_fill_brewer(palette="Paired")  + 
  geom_bar(stat='identity') +
  labs(fill = 'SPD Collision Type', x = 'Vehicle Count') +
  scale_x_continuous(breaks = seq(0, 15, 1)) +
  mylayer_long_xlabel 
```

It appears that 'Rear End' collisions involve noticably more vehicles in single incidents. This chart shows percentages, not counts, so we do not know from this plot just how many collisions involve these multiple vehicles.

###\
Has the rate of DUI collisions changed over the years?

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Plot only the known DUI 
ggplot(data = subset(create_summary(dfu, Year, DUI), DUI == 'Y'), aes(x = Year, y = perc)) +
  scale_fill_brewer(palette="Dark2")  + 
  geom_bar(stat='identity')  +
  scale_y_continuous(labels = percent_format() ) 

```

Interestingly, the lowest recorded DUI rate was the same year as our second-highest total collision year (**2015**). What happened in 2015 to cause such a drop?

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Put the Legend at Bottom  ... Or, duplicate the above plot but bring y-axis all the way up to 100%, that will keep this looking "univariate".

ggplot(data = create_summary(dfu, Year, DUI), aes(x = Year, y = perc, fill = factor(DUI))) +
  scale_fill_brewer(palette="Dark2")  + 
  geom_bar(stat='identity')  +
  scale_y_continuous(breaks = seq(0, 100, 10) ) +
  scale_y_continuous(labels = percent_format() ) +
  theme(legend.position = 'bottom', legend.direction = 'vertical') +
  labs(fill = 'DUI')

```

However, when we plot the rate of DUI in perspective with all collisions, the DUI rate changes lose their punch and appear relatively steady.

###\
Let's look at the same plot for DISTRACTED. 

Although DISTRACTED was not strongly correlated with other factors, we did see in the Univariate section that DISTRACTED has a similar rate as DUI, so let's see how the DISTRACTED rate changed over the years. 

```{r echo=FALSE, warning=FALSE, message=FALSE, DISTRACTED}

ggplot(data = create_summary(df, Year, DISTRACTED), aes(x = Year, y = perc, fill = DISTRACTED)) +
  scale_fill_brewer(palette="Dark2")  + 
  geom_bar(stat='identity')  +
  scale_y_continuous(breaks = seq(0, 100, 10) ) +
  scale_y_continuous(labels = percent_format() ) +
  theme(legend.position = 'bottom', legend.direction = 'vertical')

```

There was a significant increase in DISTRACTED being a factor in collisions, starting in the year 2013. Perhaps this is a result of the increase in the use of mobile devices, or directives for the SPD to record 'DISTRACTED' as a factor in collisions. More data is required to do any more analysis, outside the scope of this study.


###\
SPD Reports vs SDOT Records

In the Univariate section, we saw a possible disparity between SPD's reporting of collision factors and SDOT's follow-up recording of these factors. Let's look into this a little more.

####\
View By Count
```{r echo=FALSE, warning=FALSE, message=FALSE, SPDvsSDOT}

ggplot(data = create_summary(df, SDOTtype, COLLISIONTYPE), 
       aes(x = SDOTtype,
           y = count, 
           fill = factor(COLLISIONTYPE))) +
  scale_fill_brewer(palette="Paired")  + 
  geom_bar(stat='identity') +
  labs(x = 'SDOTtype', fill = 'SPD COLLISIONTYPE') +
  mylayer_long_xlabel
```

It's interesting that SPD reports categorizing a collision as 'Sideswipe', eventually gets categorized by the SDOT as 'Other Collision' or 'Rear End'. Also, it appears that SPD 'Pedestrian' labels frequently show up in SDOT records as 'Head On'. 

####\
View By Percent

View the same information as the plot above, but show the percentages of COLLISIONTYPE's within each SDOTtype, instead of count:

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(data = create_summary(df, SDOTtype, COLLISIONTYPE), 
       aes(x = SDOTtype, y = perc, fill = factor(COLLISIONTYPE))) +
  scale_fill_brewer(palette="Paired")  + 
  geom_bar(stat='identity') +
  scale_y_continuous(labels = percent_format()) +
  labs(x = 'SDOTtype', fill = 'SPD COLLISIONTYPE') +
  mylayer_long_xlabel

```

Plotting by percentage makes it easier to see the spread of COLLISIONTYPEs. For example, we can now easily see that SPD 'Sideswipe' (yellow) are also found in SDOT 'Hits Pedestrian' records. 

Also, we can now see that SPD reported collisions involving Cycles are spread-out over several SDOT categories. 

It is possible that SDOT reclassifies Collision Types after all the dust settles and more facts are available. It would be interesting to dig a little deeper into reclassifications.

### \
Let's do a similar study of JUNCTIONTYPE vs ADDRTYPE.

```{r echo=FALSE, warning=FALSE, message=FALSE, JUNCTIONvsADDR}

ggplot(data = create_summary(df, ADDRTYPE, JUNCTIONTYPE), 
       aes(x = ADDRTYPE,
           y = count, 
           fill = factor(JUNCTIONTYPE))) +
  scale_fill_brewer(palette = "Paired")  + 
  geom_bar(stat='identity') +
  labs(x = 'AddrType', fill = 'JunctionType') +
  mylayer_long_xlabel
```

It appears that the the reportings of JUNCTIONTYPE and ADDRTYPE classifications are fairly in sync, that JUNCTIONTYPE is used as a sub-category to ADDRTYPE. 


### \
Has the distribution of any Collision types **rates** changed over the years? 

```{r echo=FALSE, warning=FALSE, message=FALSE}

p1 <- ggplot(data = create_summary(df, Year, SDOTtype), 
       aes(x = Year, y = perc, fill = factor(SDOTtype))) +
  geom_bar(stat='identity') +
  labs(fill = 'SDOTtype')  +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Dark2")  

p1  +
  theme(legend.position = 'bottom') 

```

Surprisingly, it appears the % of collisions with **'Hits Pedestrian'** rose significantly around the years where there were fewer total collisions (2010-2011). Are there more pedestrians on the road, and fewer drivers? Maybe more inattentive pedestrians getting hit? That would be an interesting further study, but outside the scope of this project since DISTRACTED does not specify who was inattentive.

It will be interesting to look more into the Hits Pedistrian increase. 

### \
Adjusted **Hits Pedestrian**

>There are several variables that indicate a Pedestrian was involved in a collision (COLLISIONTYPE, SDOTtype, PEDCOUNT). Are all pedestrian-related collisions being marked by SDOT as 'Hits Pedestrian'? 
>
>Let's Bundle all records with any Pedestrian indicator into 'Hits Pedestrian'. Will the increased trend of 'Hits Pedestrian' records stay the same, or even out across the years?

```{r echo=FALSE, warning=FALSE, message=FALSE}

df$SDOTtype.Adjusted <- df$SDOTtype

df <- df %>%
  mutate(SDOTtype.Adjusted = case_when(
    .$SDOTtype == 'Hits Pedestrian' ~ 'Hits Pedestrian',
    .$COLLISIONTYPE == 'Pedestrian' ~ 'Hits Pedestrian',
    .$PEDCOUNT >= 1 ~'Hits Pedestrian',
    TRUE ~ as.character(SDOTtype)) )

ggplot(data = create_summary(subset(df, SDOTtype.Adjusted == 'Hits Pedestrian'), SDOTtype.Adjusted, SDOTtype), 
       aes(x = SDOTtype.Adjusted, y = perc, fill = factor(SDOTtype))) +
  scale_fill_brewer(palette = "Dark2")  + 
  geom_bar(stat='identity') +
  scale_y_continuous(labels = percent_format()) +
  labs(fill = 'SDOTtype')  
```

Here we see approximately 25% of the records with some indication of Pedestrian involvement were originally classified as 'Head On'. This suggests that most pedestrians are hit with the front of a car, as opposed to sideswiped or rear-ended.

#### If we re-classify all the above as 'Hits Pedestrian', will the trend change?

```{r echo=FALSE, warning=FALSE, message=FALSE}

p2 <- ggplot(data = create_summary(df, Year, SDOTtype.Adjusted), 
       aes(x = Year, y = perc, fill = factor(SDOTtype.Adjusted))) +
  geom_bar(stat='identity') +
  labs(fill = 'SDOTtype.Adjusted') +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Dark2") 

mylayer_hline <- geom_hline(yintercept=.75)

prow <- plot_grid(p1 + theme(legend.position='none') + mylayer_hline + 
                    scale_x_discrete(breaks = seq(2004, 2018,4)),
                  p2 + theme(legend.position='none') + mylayer_hline + 
                    scale_x_discrete(breaks = seq(2004, 2018,4)) + ylab(''), 
                  labels = c('','Adj->'),
                  hjust = .1,
                  nrow = 1
                  )
legend_shared <- get_legend(p2 + theme(legend.position = 'bottom')) 
plot_grid(prow, legend_shared, ncol = 1)

rm(legend_shared)

```

Comparing the original and the Adjusted plots, it appears that the ratios are pretty much stay the same, except some of the 'Head On' records got moved to 'Hits Pedestrian'. 

**Theory**:  Whatever causes the SPD and SDOT discrepancies in 'Pedestrian' reporting  appears to be consistent, and the increased rate in 'Hits Pedestrian' is true (we cannot reject the null hypothesis that pedestrian's getting hit rate did not change.)


###\
DUI relationships

####\
SEVERITY

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(data = dfu, 
       aes(x = factor(SEVERITYDESC, level = severity_level_order), 
           y = DUI, color=SEVERITYDESC)) +
  geom_point(alpha = 0.5, size = 1, aes(size = 1), position = 'jitter') +
  mylayer_color +
  labs(y = 'DUI', x = 'SEVERITYDESC') +
  coord_flip()

```

The proportions **appear** similar between non-DUI and DUI, in that the more serious the Severity, the fewer the collisions count, whether DUI is true or not.

What if we did look at the proportions instead of counts, will the proportions still appear the same, as suggested as in the plot above? While we're at it, let's compare proportions for the DISTRACTED variable.

```{r echo=FALSE, warning=FALSE, message=FALSE}

p1 <- ggplot(data = create_summary(dfu, DUI, SEVERITYDESC), 
       aes(x = DUI, y = perc, fill = factor(SEVERITYDESC, levels=rev(severity_level_order)))) +
  mylayer_fillcolor  + 
  geom_bar(stat='identity') +
  scale_y_continuous(labels = percent_format()) +
  labs(fill = 'SEVERITYDESC')  

p2 <- ggplot(data = create_summary(df, DISTRACTED, SEVERITYDESC), 
       aes(x = DISTRACTED, y = perc, fill = factor(SEVERITYDESC, levels=rev(severity_level_order)))) +
  scale_fill_brewer(palette="Dark2")  + 
  geom_bar(stat='identity') +
  scale_y_continuous(labels = percent_format()) +
  labs(fill = 'SEVERITYDESC') 


prow <- plot_grid(p1 + theme(legend.position='none'),
                  p2 + theme(legend.position='none'),
                  nrow = 1
                  )

legend_shared <- get_legend(p2 + theme(legend.position = 'bottom', legend.direction = 'vertical' ))

plot_grid(prow, legend_shared, ncol = 1)

rm(legend_shared)

```

The proportions of Severity for DUI are similar but not the same. Here we see there are more serious severities in DUI collisions.

Interestingly, the rates of Severity between DUI and DISTRACTED indicators are very similar, although Severity tends to be a worse in DUI collisions.

Later, let's see if other factors come into play with the seriousness of DUI. For example, perhaps more DUI collisions occur at night, when people tend to inbibe. 

####\ 
Out of curiosity, how often are DUI and DISTRACTED both marked as factors on the **same** Collision report?

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(data = create_summary(df, DUI, DISTRACTED), 
       aes(x = DUI, y = perc, fill = DISTRACTED)) +
  scale_fill_brewer(palette="Dark2")  + 
  geom_bar(stat='identity') +
  scale_y_continuous(labels = percent_format()) +
  geom_text(aes(label = paste0(round(100*perc,2),"%")), 
            position = position_stack(vjust = 0.5),
            size = 3)

```

Most reports with any DUI value ('Y' or 'N'), DISTRACTED is not marked. All reports with no DUI value, DISTRACTED also has no value.

This plot was just for curiosity, I will no longer pursue DISTRACTED analysis.


### \
Other DUI relationships

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Function to plot bar graph of percentages given data and bar & fill columns.
plot_under <- function(data, x_col, fill_col, mapping) {
  x_col <- enquo(x_col)
  fill_col <- enquo(fill_col)
  
  df_p <- data %>%
    group_by(!! x_col, !! fill_col) %>%
    summarise(count = n()) %>%
    mutate(perc = count/sum(count)) 

  p <-  ggplot(data = df_p, mapping) +
    scale_fill_brewer(palette="Paired")  + 
    geom_bar(stat='identity') +
    scale_y_continuous(labels = percent_format()) +
    labs(x='DUI', y='Percent') 
  
  p   # return the plot
}

``` 


```{r echo=FALSE, warning=FALSE, message=FALSE}

p1 <- plot_under(subset(dfu, LIGHTCOND != ''), DUI, LIGHTCOND, aes(x = DUI, y = perc, fill = factor(LIGHTCOND)))+
  guides(fill=guide_legend(title='Light Condition')) + labs(title='Light') +
  theme(axis.title.x = element_blank() )

p2 <- plot_under(subset(dfu, WEATHER != 'Other'), DUI, WEATHER, aes(x = DUI, y = perc, fill = factor(WEATHER)))+
  guides(fill=guide_legend(title='Weather Description')) + labs(title = 'Weather')  +
  theme(axis.title.x = element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank()) 

p3 <- plot_under(subset(dfu, SDOTtype != ''), DUI, SDOTtype, aes(x = DUI, y = perc, fill = factor(SDOTtype)))+
  guides(fill=guide_legend(title='Collision Type')) + labs(title='Collision Type') 

grid.arrange(p1, p2, p3, ncol=2)

rm(p1,p2,p3)

```

**Light Conditions** has the most significant differences between non-DUI and DUI. There are significantly more collisions in the 'Dark - Street Lights On' when DUI. Whether or not this is simply a factor of time (night time being when the streetlights are on and, perhaps, when more people are DUI), and less to do with the fact that the street lights are on, is a question requiring further study. 

Although **Weather Condition** had a strong correlation (.6) with DUI, there does not appear to be a significantly difference of Weather in the non-DUI collisions. Although, it is worth noting that very few collision reports neglected to report the WEATHER ('Unknown') for DUI collisions. This may be another indication that SPD reports are more completely filled-out when DUI is suspected.  

**Collision Type** of 'Other' is more than double when DUI is True, but Sideswipes are significantly less, as are 'Hits Pedestrian'.


### \
Let's look a little closer at the SDOTtype and LIGHTCOND plots in larger scale.


#### DUI and SDOTtype
```{r echo=FALSE, warning=FALSE, message=FALSE}

plot_under(dfu, DUI, SDOTtype, aes(x = DUI, y = perc, fill = factor(SDOTtype)))

```

It would be interesting to break-down 'Other' Collision Types for more details.

#### DUI and LIGHTCOND

```{r echo=FALSE, warning=FALSE, message=FALSE}
plot_under(dfu, DUI, LIGHTCOND, aes(x = DUI, y = perc, fill = factor(LIGHTCOND)))
```

Is it possible that glare from Street Lights could be a factor in DUI collisions? \
(digging into this more is way outside the scope of this project)

### \
How are counts by LIGHTCOND spread out across the day? 

```{r echo=FALSE, warning=FALSE, message=FALSE}
mylayer_hour_breaks <- scale_x_datetime(labels = date_format("%H:%M"), date_breaks = ('2 hours')) 

time_counts <- df %>%
  count(DayPart, Hour, LIGHTCOND)

# Identify what part of the day the crime occurred
ggplot(data = subset(time_counts, !is.na(Hour) & !(LIGHTCOND %in% c('', 'Other', 'Unknown'))),
       aes(x = Hour, y = n, color = LIGHTCOND), size = 1.5, alpha = 0.6) +
  geom_point(alpha = .6, size = 3) +
  facet_wrap(~ DayPart, scales = 'free_x', ncol=2)  +
  mylayer_color 
```

Higher counts by LIGHTCOND at certain parts of the day hold no surprises: collisions in afternoons will naturally tend to be during Daylight.

It is interesting that most collisions occur during the afternoon. Is road volume a contributing factor?

#### \
LIGHTCOND and TIME line graph.

Let's look at the same data, in a line graph format. It may be easier to see what's going on. Let's also look at percentages instead of counts.


```{r echo=FALSE, message=FALSE, warning=FALSE}

time_perc <- subset(df, !is.na(Hour) & !(LIGHTCOND %in% c('', 'Other', 'Unknown'))) %>%
  group_by(Hour, LIGHTCOND) %>%
  summarise(count = n()) %>%
  mutate(perc = count/sum(count))


ggplot(data = time_perc,
       aes(x = Hour, y = perc, color = LIGHTCOND)) +
  geom_line(size = 2) +
  mylayer_color +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"))

```

Again, no surprises here ... LIGHTCOND and Hour are paired.

####\
Is there a change in hourly-collision patterns between the 2-highest and 1-lowest years?

```{r echo=FALSE, warning=FALSE, message=FALSE}

by_year_hour <- df %>%
  group_by(Year, Hour) %>%
  summarise(count = n()) 


ggplot(data = subset(by_year_hour, Year %in% c(2005, 2010, 2015)),
       aes(x = Hour, y = count)) +
  geom_line(aes(color = Year), size = 1) +
  ylim(0,1200) 

```

2015, our second-hightest ranking year, has a more distinctive peak during the lunch hours, as well as overall increase during the day. Interestingly, this same hear saw a smaller midnight collision count than the other two years.

2005, our lowest year, had a small drop in the morning commute hours that the other two years did not. Plus, there is a plateau of collision counts around the lunch hour that the other years did not have, and the spike in the evening commute is less pronounced.


# \
Bivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the dataset?

#### Collision Types and Vehicle Counts

* There are a few patterns to Collision types and the number of vehicles that tend to be involved in each type. Apparently, 'Sideswipe' incidents involve anywhere bewteen 2 and 9 vehicles. Most 'Pedestrian' incidents involve just one car, but there is at least one 'Pedestrian' that involved 7 cars. 

#### Low and High year daily trends

Comparing our two highest incident count years, 2005 & 2015, with our lowest year 2010:

2015 had more incidents during lunch hours, as well as overall increase during the day, but fewer midnight collisions. Were more people commuting to work and venturing out less at night??

2005 had a small drop in the morning commute hours that the other two years did not see. Plus, there is a plateau of collision counts around the lunch hour that the other years did not have, and the spike in the evening commute is less pronounced. Were fewer people commuting that year?

#### DUI and other factors

* The total number of DUI reports have changed over the years, but the rate of change is not dramatic.

* In the span of the average day, there is a definite trend in that DUI's generally occur in the evening and night hours.

* DUI's are involved in fewer 'Sideswipe' and 'Pedestrian' collision types, and more 'Other', suggesting more digging into 'Other' is needed.

* DUI incidents tend to have higher severities.

#### SPD vs SDOT Classifications

* There is a difference between SPD's and SDOT's categorization of collisions, which is interesting but appear to be consistent. It was SPD's COLLISIONTYPE that proved to have stronger correlations with other factors, but for the sake of simplicity in my analysis, I chose to continue using SDOT's categories in my plots.

* There appeared to be anomalies when it came to SPD's reporting of Pedestrian related collisions, and SDOT's recordings of them. It turns out that whatever is happening between reporting and recording is consistent. It appears that SDOT categorizes some Pedestrian hits as 'Head On' as opposed to 'Hits Pedestrian'.


### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

* DISTRACTED increased significantly starting around 2013.

* Most collisions happen in LIGHTCOND = 'Daylight', and during the afternoons.

* I'm surprised that LIGHTCOND did not have a higher score with Hour in the correlation tables, and had a weak relationship with DayPart. 

* It appears that JUNCTIONTYPE is a subset of ADDRTYPE.

* Weather (surprisingly, the cor value is high, but there is little difference between DUI and non-DUI weather, other than fewer DUI records are marked with WEATHER='Unknown')

* Light Condition (not surprisingly, DUI collisions are mostly in Street Light conditions)


### What was the strongest relationship you found? 

In general, DUI and VEHCOUNT each have the strongest relationships with other features.  

The strongest relationship was between DUI and LIGHTCOND. The LIGHTCOND of 'Street Lights On' more than doubles when DUI is true. However, this may very well be a 'correlation is not causation' example, in that DUI people may more frequently be driving at night when street lights just happen to be on.


#\
Multivariate Plots Section

In this section, I dig deeper into exploring relationships between: 

* DUI & SEVERITYCODE, with LIGHTCOND and time of day
* DUI rate changes & total collision count trends
* Annual Fatalities by Collision Type
* SPD vs SPOD collision types & Vehicle Counts


### \
How are DUI, LIGHTCOND, and SEVERITYCODE related?

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(dfu, aes(x = as.factor(DUI), y = LIGHTCOND)) + 
  geom_jitter(alpha = 0.5, aes(color = SEVERITYDESC)) +
  scale_size_manual(values = c(1,3,5,7))   +
  mylayer_color +
  mylayer_x90 +
  labs(x = 'DUI')  
```

There are differences between DUI and non-DUI collisions as they relate to both Light and Severity:

* LIGHTCOND is frequently under-reported (value = Null, 'Unknown' or 'Other') when DUI=Null, especially when the Severity is 'Property Damage Only'.

* DUI is true, it appears more of an effort is made to specify the Light Condition, especially if there is a fatality.

####\
How about we simplify and look at the part of the day instead of the LIGHTCOND, ignorning the 'Unknown's?

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(data = subset(dfu, !is.na(DayPart) & SEVERITYDESC %in% c('Injury','Serious Injury','Fatality')), 
       aes(x = factor(DayPart, level = c('Night','Evening','Afternoon','Morning')), 
           y = DUI) 
       ) +
  geom_point(position = 'jitter', 
             alpha = .5,
             aes(
               size=factor(SEVERITYDESC, level=(severity_level_order)),
               color=factor(SEVERITYDESC, level=(severity_level_order))
                )
             ) +
  #scale_color_manual(values=c("#b2e4cf", "#e4e4b2",'#da897c')) +
  labs(y = 'DUI',  x = '', color = '', size = '') +
  guides(color=guide_legend(), size = guide_legend()) +
  coord_flip()

```

###\
How does the rate of DUI collisions changes compare to total collisions over the years?

```{r echo=FALSE, warning=FALSE, message=FALSE}
p2 <- 
  geom_bar(data = df %>% count(Year), 
           aes(x = Year, y = n),
           stat = 'identity')

p1 <- geom_line(data = subset(create_summary(dfu, Year, DUI), DUI == 'Y'), 
                aes(x = Year, y = (perc)*100000, group = 1), color = 'tomato', size = 1.5)  

ggplot() +
  p2 +
  p1 +
  scale_x_discrete(breaks = c('2004','2006','2008','2010','2012','2014','2016','2018')) +
  scale_y_continuous('Count of All Collisions', sec.axis = sec_axis(~ ((./100000)), name ='% of Collisions DUI'))+
  theme(axis.text.y.right = element_text(color = 'tomato'),
        axis.title.y.right = element_text(color = 'tomato'),
        axis.line.y.right = element_line(color = "tomato"), 
        axis.ticks.y.right = element_line(color = "tomato"))

```

Although DUI rates change very little over the years, they do seem to drop in rate when the total number of collisions rise.


###/
When DUI's happen, compared to when Injuries happen.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multi_1}

# Injury by hour data
dfi <- subset(df, SEVERITYDESC %in% c('Injury','Serious Injury','Fatality'))

p_bar <-
  geom_bar(data = dfi, 
       aes(x = Hour, fill = factor(SEVERITYDESC, levels=rev(severity_level_order)), y = (..count..) )) 
  
# DUI by hour data
dfh <- subset(df, DUI == 'Y') %>%
  group_by(Hour) %>%
  summarize(count = n())

p_line <-
  geom_line(data = dfh, aes(x = Hour, y = count, linetype = 'DUIs'), size = 1.5) 


# Now combine 2 plots
ggplot() +
  p_bar +
  p_line +
  scale_x_continuous(breaks = seq(0, 23, 2)) +
  labs(fill = 'SEVERITYDESC') +
  scale_fill_manual(values=c('#da897c', "#e4e4b2","#b2e4cf"))

rm(dfi, dfh)

```

This plot suggests that, although the total number of collisions between midnight and 4am are at their lowest, most of these collisions can be attributed to DUIs.

Also, the number of serious injuries increases during commute hours (4-6pm), and the number of fatalities his highest around 6pm, and around 9pm.


### \
What kind of collisions involve fatalities, and on average how many annually?

```{r echo=FALSE, warning=FALSE, message=FALSE, MultiBoxes}

fatality_counts <- 
  subset(df, SEVERITYDESC %in% c('Fatality')) %>%
  group_by(Year, SDOTtype.Adjusted) %>%
  summarise(total = sum(FATALITIES))

p_f <- 
  geom_boxplot(data = fatality_counts,
               aes(x = '', y = total,
                   color = SDOTtype.Adjusted))

ggplot() +  p_f +
  facet_wrap(~ SDOTtype.Adjusted)  +
  theme(legend.position = 'bottom', legend.direction = 'horizontal') +
  labs(title = 'Annual Fatality Counts by SDOT Collision Type', x = '', color = 'SDOTtype.Adjusted') +
  mylayer_color 
```

In collisions that involved fatalities, on average most were 'Hits Pedestrian' and 'Other Collision'. There were a few outliers in each of 'Sideswipe' and 'Other Collision', with more than 2x the annual average fatalities in certain years. Not surprisingly, there were the fewest fatalities in 'Struck Object'.

More analysis would be required to figure out what 'Other Collision' involves. Looking at SPD's COLLISIONTYPE helps, but they even have a significant 'Other' category with a significant number of 'Other' fatalities. But we can see here that some annual fatalities involve 'Cycles' and 'Head On':

```{r echo=FALSE, warning=FALSE, message=FALSE, MultiBoxes2}

fatality_counts2 <- 
  subset(df, SEVERITYDESC %in% c('Fatality') & SDOTtype.Adjusted %in% c('Other Collision')) %>%
  group_by(Year, COLLISIONTYPE) %>%
  summarise(total = sum(FATALITIES))

p_f2 <- 
  geom_boxplot(data = fatality_counts2,
               aes(x = '', y = total,
                   color = COLLISIONTYPE))

ggplot() +  p_f2 +
  facet_wrap(~ COLLISIONTYPE)  +
  theme(legend.position = 'bottom', legend.direction = 'horizontal') +
  labs(title = 'Annual Fatality Counts by SPD Collision Type WHEN SDOT is "Other"', x = '', color = 'SDOTtype.Adjusted') +
  mylayer_color 
```


###\
SPD vs SDOT with VEHCOUNTS

In the Bivariate section, we explored the SPD's Collision relationship with VEHCOUNT. Now let's also compare VEHCOUNT with SDOT's Collision categories, to see what the differences are, if any.

```{r echo=FALSE, warning=FALSE, message=FALSE, SPDvsSDOTandVEHCOUNT}

p1 <- ggplot(data = create_summary(df, VEHCOUNT, COLLISIONTYPE),
       aes( fill = factor(COLLISIONTYPE))) +
      geom_bar(aes(x = VEHCOUNT, y = perc), stat='identity') +
      scale_fill_brewer(palette="Paired")  +
      labs(fill = 'SPD Collision Type', x = 'Vehicle Count') +
      scale_x_continuous(breaks = seq(0,15,1)) +
      mylayer_long_xlabel 

p2 <- ggplot(data = create_summary(df, VEHCOUNT, SDOTtype),
       aes( fill = factor(SDOTtype))) +
      geom_bar(aes(x = VEHCOUNT, y = perc), stat='identity') +
      scale_fill_brewer(palette="Paired")  +
      labs(fill = 'SDOT Collision Type', x = 'Vehicle Count') +
      scale_x_continuous(breaks = seq(0,15,1)) +
      mylayer_long_xlabel 

grid.arrange(p1, p2, ncol=1)

```

Where as the SPD tends to not categorize all the VEHCOUNT=0 reports (COLLISIONTYPE=''), SDOT follows these incidents up by assigning their own categorization to the incident. Also, in the VEHCOUNT=12 column (there may have been only 1 VEHCOUNT=12 record), the SPD marked it as 'Parked Car' while SDOT followed-up and categorized the incident(s) as 'Hits Pedestrian'.  There are a number of other inconsistencies that would require further analysis outside the scope of this project.

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

The DUI / Light Condition / Severity relationship is strong: DUI collisions tend to happen when 'Street Lights - On', and they also tend to have higher severities. 

Also, DUI / Time of Day / Severity relationships are strong, in that LIGHTCOND and Time are strongly paired. 

It appears that if there is an incident between approximately 12am and 4am, it will most likely involve a DUI.

Looking averages across the years, reports suggest that most fatalities occur with 'Hits Pedestrian' and 'Other'.


### Were there any interesting or surprising interactions between features?

The disparity between SPD and SDOT collision categorization is made clearer when looking at Fatality averages. It is unclear why SDOT categorizes some 'Other' collisions when SPD categorizes them as 'Head On', and some of those may involve pedestrians.

I am surprised to see that (generally) when annual DUI rates are up, total collision incident counts are down.


------

# Final Plots and Summary

### Plot One - Trends in Time

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Data
by_year <- df %>%
  group_by(Year) %>%
  summarise(count = n()) %>%
  mutate(highlight = ifelse( Year %in% c('2005','2015'), 'high', ifelse( Year == '2010', 'low', 'mid')))

# Formatting
mylayer_subtitle <- theme(plot.subtitle = element_text('size' = 14, face = 'bold')) 

# By Year plot
p1 <- ggplot(data = by_year, 
             aes(x = Year, y = count, fill = highlight)) +
  geom_bar(stat='identity') +
  scale_fill_manual(values = c( 'low'='grey90', 'high' = 'grey40', 'mid' = 'grey70'), guide = FALSE) +
  scale_x_discrete(breaks =c('2005', '2010', '2015')) +
  labs(y = '', subtitle = 'By Year') +
  background_grid() +
  mylayer_subtitle
  
# By Time plot
g1 <- geom_point(data = df %>% count(Hour), aes(x = Hour, y = n ))
g2 <- geom_smooth(data = df %>% count(Hour), aes(x = Hour, y = n ), color='grey40')
g3 <- geom_line(data = df %>% count(Hour), aes(x = Hour, y = n )) 

p2 <- ggplot() +  g2  + ylim(0,16000) +
  labs(x = 'Time (Hour on a 24-hour clock)',
       y = '',
       subtitle = 'By Time of Day') +
  theme(axis.text.y = element_blank()) +
  background_grid() +
  mylayer_subtitle

# Combine plots
mytitle = text_grob('Seattle Collision Incident Trends, 2004-2018\n', just = 'center', size = 16, face = 'bold', rot = 0)
myy = text_grob('Collision Incident Count', size = 14, face = 'bold', rot = 90)
grid.arrange(p1, p2, ncol=2, 
             top = mytitle,
             left = myy)
```


### Description One
 
I wanted to introduce the Seattle Collisions dataset with a simple visual illustrating collision incident trends over time (across the Years, and through the course of an average day.)

The **By Year** plot shows the presence of a repeated rise-and-fall trend, highlighting 2 peak years (2005 and 2015) and 1 valley year (2010).

The **By Time of Day** presents a simple trend of collision frequencies throughout any given day, with a trend of increasing incidents from morning until afternoon commute hours.

#### Design justifications
I chose to use a 2-column grid, as opposed to a 1-column/2-row grid, so the y-axis would be taller. I did this because the range of incident counts (y-axis) is fairly large (up to 15,000), and wanted the plot to represent the large change in counts from year to year. If I used a 1-column grid, the difference in years would presented as subtle. If I had used the more subtle chart, I felt the need to print a rate changes on each bin to show the differences, which proved to be too distracting. 

I debated whether to include a point-line in the **By Time of Day** plot, to show where points actually sat in relation to the smoother slope. I decided to keep the plot simple, as it's purpose was to simply show the general trend of collision incidents throughout the day.

I chose a **grey color scheme** to keep the charts simple. I did not want colors to distract from the main point (the trends). However, I did vary a scale of grey on the 2-highest and 1-lowest incident count **By Years** to draw the audience's attention to those extremes.

### \
Plot Two - Categorical Differences

```{r echo=FALSE, warning=FALSE, message=FALSE, Plot_2}

ggplot(data = create_summary(df, SDOTtype, COLLISIONTYPE), 
       aes(x = SDOTtype, y = perc, fill = factor(COLLISIONTYPE))) +
  scale_fill_brewer(palette="Paired")  + 
  geom_bar(stat='identity') +
  scale_y_continuous(labels = percent_format()) +
  labs(x = 'SDOT Categories',
       y = 'Percent (of each SPD Category)',
       title = 'SPD vs SDOT Incident Categorizations',
       fill = 'SPD Category') +
  mylayer_long_xlabel

```

### Description Two

I chose this plot because it shows the disparity between how the SPD (Seattle Police Department) and SDOT (Seattle Department of Transportation)  choose to categorize each incident. For example, the left two bins show that when SDOT categorizes an incident as 'Heads On', the SPD had already categorized it as 'Pedestrian'. The SPD and SDOT had the same classification for very few of the 'Heads On' and 'Pedestrian' labels. Less than 50% of the time they agreed on 'Rear Ended' classifications. 

It is possible that both systems of categorization are coordinated intentionally, that the absense of matching values is not of disagreement but that by using both we get better picture of each incident. It may also suggest the dataset could be enhanced if each category was a boolean factor, as opposed to two single-value factors.

#### Design justifications

I chose bright colors (from a colorblind-friendly color scheme) to emphasize the SPD vs SDOT disparities. I hope the audience's first impression to see the presense of a complication, and interesting enough to spend a few moments comparing the SPD vs SDOT incident classifications.


### \
Plot Three - DUI Severities

```{r echo=FALSE, warning=FALSE, message=FALSE, Plot_Three}

ggplot(data = dfu, 
       aes(x = factor(SEVERITYDESC, level = severity_level_order), 
           y = DUI, 
           color=factor(SEVERITYDESC, level=rev(severity_level_order))) ) +
  geom_point(alpha = 0.5, size = 1, position = 'jitter', show.legend = FALSE) +
  geom_label(data = create_summary(dfu, DUI, SEVERITYDESC),
             mapping = aes(label = label), 
             alpha = 0.8, color = 'grey10', 'size' = 5, face = 'bold',
             label.padding = unit(0.5, 'lines')) +
  scale_y_discrete(labels = c('Non-DUI','DUI')) +
  mylayer_color +
  labs(y = NULL, x = 'Collision Severity',
       title = 'Collision Severity Rates, Non-DUI vs DUI') +
  coord_flip() 

```

### Description Three

I chose this plot to illustrate the increased rate of injury and death in DUI incidents versus non-DUI incidents. DUI incidents have a 10 times greater chance of resulting in Fatalities, and more than 3 times greater chance of Serious Injuries.

#### Design justifications

I debated whether or not to use points in this plot, since the number of DUI incidents are far fewer than non-DUI, therefore resulting in fewer points on the plot (even though the top three rates are higher). I decided to include the points because I wanted to demonstrate that, even though there are fewer DUI incidents, their rate of fatalities and injuries are much higher.

I also removed the color legend because it would have been redundant with the y-axis labels. 

------

# Reflection

#### The dataset

I wanted to challenge myself with this project by finding my own dataset to use.

I initially thought the Seattle Collisions was clean. While exploring the data, I progressively realized that was not quite true. I discovered the **hard way** that cleaning does take significant time (as warned in the project instructions!) Not just the time for writing code, but the time it takes to dig deeper into the data in order to make ethical decisions on how best to clean while avoiding the unintentional misrepresention of data.

Also, this dataset has very few quantitative factors, making it challenging to create a variety of graph types. That being said, **I learned more** about plotting in R than I may not have otherwise. I learned quite a bit by experimenting with color, scale, labels, and which plot types to use with which data type.

I enjoyed the 'running commentary, stream of thought' nature of this data exploration project. By not strategizing too much ahead of time exactly what I wanted to conclude at the end, I made a few surprising discoveries.

#### The data 

I was surprised that annual collision counts did not steadily rise over the years, but has a distinct rise/fall pattern. **Additional analysis** in future work should introduce Seattle Population estimates, to see how it correlates with collision data, and patterns of incident factors over time.

I was not surprised there is an increase in the rate if 'DISTRACTED' collisions, given the rise in the use of mobile devices. This may also be an interesting study for **future work**.  What would 'Innattention' patterns reveal with more study of how (and how often) mobile devices are used by car occupants as well as pedestrians and cyclists.

Looking into the SPD vs SDOT categorizations made it more real to me how important it is to know how data is collected and stored before it even gets to the analyst, otherwise it's difficult to make any ascertions about the data and what it represents. For example, are the SPD and SDOT categorizations of each incident a coordinated effort to describe an incident, or is data collection inconsistent or incomplete?
