---
title: "Wrangle Seattle collision data"
author: "Leah Erb"
---

```{r echo=FALSE, message=FALSE, warning=FALSE, Stylize}
# Stylize our output
knitr::opts_chunk$set(comment=NA, fig.width=9, fig.height=6)
```


```{css echo=FALSE, message=FALSE, warning=FALSE, CSS}
/* Define a margin before header elements */
h1  {
  margin-top: 52px;
}
h2, h3, h4  {
  margin-top: 48px;
}
/* Define a margin after every first p elements */
p:first-of-type {
  margin-bottom: 14px;
}
``` 

***
# Libraries and functions
```{r message=FALSE, warning=FALSE, Libraries_Functions}
# libraries
library(data.table) # renaming columns
library(stringr)    # 'word' function
library(dplyr)
library(tidyverse)
library(knitr)

print_date_range <- function(this_df){
    # Prints min and max INCDATE of this_df
    this_df %>%
        summarize(min_INCDATE = min(as.Date(this_df$INCDATE)),
                  max_INCDATE = max(as.Date(this_df$INCDATE)))
}

print_null_count <- function(this_df) {
    # Print columns with NULLs and their counts
    dfNulls <- sapply(df, function(x) sum(is.na(x)))
    as.data.frame(dfNulls[dfNulls > 0]) %>% rename_at(1, ~'null_count')
}

# helper function
count_vals <- function(this_df) {
    # Return value counts and proportions of this_df
    return(
        this_df %>% 
            tally() %>% 
            mutate(freq = (n_pct = (n / sum(n)) * 100))
    )
}

print_value_counts <- function(this_df, cols) {
    # Print value count and proportions of a list of columns
    lapply(this_df[cols], function(x) {
        x <- enquo(x)
        kable(
        df %>% 
            group_by(fct_explicit_na(!! x)) %>% 
            count_vals
        , caption = deparse(substitute(this_df)))
    })
}

options(scipen=6)
get_column_values <- function(this_df, cols) {
    # Print value count and proportions of a list of columns
    result <- lapply(this_df[cols], function(x) {
        x <- enquo(x)
        kable(         # kable because knitr uses scientific notation instead of decimal.
        this_df %>% 
            group_by(fct_explicit_na(!! x)) %>% 
            count_vals
        , caption = deparse(substitute(this_df)))  # print this_df name not value 
    })
    
    return (result)
}

```

***
# Load data
```{r Load_data}
# toggle data source: local file or live site  TODO: default to live site
datafile = '../data/collisions.csv'
#datafile = 'http://data-seattlecitygis.opendata.arcgis.com/datasets/5b5c745e0f1f48e7a53acec63a0022ab_0.csv'

df = read.csv(datafile, na.strings=c("", " "), header=TRUE)
```

***
# Assess

```{r}
glimpse(df)
```


#### What do Date/time columns look like?
```{r warning=FALSE, message=FALSE}
head(df$INCDATE, 20)
head(df$INCDTTM, 20)
```
**Observation:** INCDATE does not contain time, INCDTTM includes dates and sometimes time.


#### What is our data's date range, and how many records in each year?

```{r}
print_date_range(df)

df %>%
    mutate(year = lubridate::year(as.Date(df$INCDATE))) %>%
    group_by(year) %>%
    tally() 
```
**Observation:** We have an outlier in year 2003, and the lastest year may not be a full 12 month's worth of data.

#### Which columns have NULL values, and how many are there?
```{r}
print_null_count(df)
```
**Observation:** date and datetime columns have no NULL values.

#### Several columns have only 1 NULL, are they all from the same record?
```{r}
cols <-  c('SEVERITYCODE', 'SDOT_COLCODE', 'SDOT_COLDESC')
subset(df, is.na(SEVERITYCODE) | is.na(SDOT_COLCODE) | is.na(SDOT_COLDESC), cols)
```
**Observation:** No.

#### Can we deduce a value for the missing SDOT_COLCODE, given other values in the record?
```{r}
subset(df, is.na(SDOT_COLCODE))
```
**Observation:** No. There is very little information recorded. Suspiciously, record is dated 2003 which is the only record for that year. I hypothesize that the 2003 record was a test insert. 


#### Can we deduce a value for the NULL SEVERITYCODE, given other values in the record?
```{r}
subset(df, is.na(SEVERITYCODE))
```
**Observation:** Yes. The NULL SEVERITYCODE could be changed to '0' because INJURY, SERIOUSINJURIES and FATALITIES = 0

#### There seems to be several collision type categories, what do they look like?
```{r}
# Print count and % of column values
cols <- c('COLLISIONTYPE', 'SDOT_COLDESC', 'ST_COLDESC')
temp_df_list <- get_column_values(df, cols)
options(tibble.print_max = 100)
options(digits=2)
temp_df_list
```
**Observations:**

* SDOT_COLDESC rowid 6 includes quotes in the text, and rowid 11 has misspelling (MOTOR VEHCILE STRUCK PEDESTRIAN)

* COLLISIONTYPE has most generalized category differentiation, with only 10 non-null values

* SDOT_COLDESC  has general categories, plus a sub-classification by what does the striking: DRIVERLESS, MOTOR VEHICLE or PEDALCYCLIST

* ST_COLDESC has the most categories (62 non-null), with more sub-classifications of what did the striking than SDOT_COLDESC


According to the Collisions_OD.pdf:
* COLLISIONTYPE is presumably assigned by the Seattle Police Department (TODO: Verify)

* SDOT_COLDESC is given to the collision by Seattle Department of Transportation

* ST_COLDESC is a code supplied by the State

We may want to dig into the data more to see if there are contradictions during analysis, or if all 3 categories support each other (a hierarchy of categories?).


#### Are SDOT_COLCODE and SDOT_COLDESC values 1:1? (Seattle Dept of Transportation)
```{r}
df %>%
    group_by(SDOT_COLCODE, SDOT_COLDESC) %>%
    summarise(count = n())
```
**Observations:** Yes.

#### Are ST_COLCODE and ST_COLDESC values 1:1?  (State's codes)
```{r}
df %>%
    group_by(ST_COLCODE, ST_COLDESC) %>%
    summarise(count = n())
```
**Observations:** Yes.


#### What do binary-esque columns look like?
```{r}
# Print count and % of column values
cols <- c('UNDERINFL', 'INATTENTIONIND', 'SPEEDING', 'HITPARKEDCAR')
print_value_counts(df, cols)
```

#### For each counts-of-things column, what % of values are > 0?
```{r}
cols <- c('PERSONCOUNT', 'PEDCOUNT', 'PEDCYLCOUNT', 'VEHCOUNT',
          'INJURIES', 'SERIOUSINJURIES', 'FATALITIES')
as.data.frame(lapply(df[,cols], 
                     function(x){
                         length(which(x != 0))/length(x) * 100
                     } 
))
```

###\ Assessment Observations
**May require cleaning:**

* INCDATE is a factor with format 'YYYY-MM-DDT00:00:00.000Z'
* INCDTTM is a factor with varying formats of 'M/DD/YY HH:MM' and 'M/DD/YY'
* Minimum INCDATE = '2003-10-06T00:00:00.000Z'
* SEVERITYCODE, SDOT_COLCODE and SDOT_COLDESC: each have only 1 NULL value. 
* The SEVERITYCODE=NA could be marked '0' instead because INJURY, SERIOUSINJURIES and FATALITIES = 0
* The only incident with no SDOT_COLCODE is also the first record (by timestamp). It may be a test insert.
* SDOT_COLCODE contains categorical data but is datatype Integer.
* Binary fields: 
* INATTENTIONIND appears to default to NULL unless specifically set to 'Y'. ( >86% NULL)
* SPEEDING       appears to default to NULL unless specifically set to 'Y'. (>95% NULL)
* HITPARKEDCAR has no NULLs, all values are 'N' or 'Y'. (>95% 'N')
* UNDERINFL is all over the map, with 0, 1, N, Y and NULL values. (> 95% 0, N or NULL)
* Some key columns may not be of use in our analysis since we not, at this time,
joining with other tables: -OBJECTID, -REPORTNO, -STATUS, -EXCEPTRSNCODE, 
-EXCEPTRSNDESC, -COLDETKEY, -INCKEY, -INTKEY, -SDOTCOLNUM, -SEGLANEKEY


**Of interest:**
*  more than 88% collisions have non-zero values for PERSONCOUNT and VEHCOUNT
*  fewer than 28% collisions have non-zero values INJURIES
*  fewer than 5% of PEDCOUNT, PEDCYLCOUNT, SERIOUSINJURIES and FATALITIES are non-zero values


#\
Clean 

### Create and clean Date/time columns
* Change INCDATE datatype to Date
* Create date/time columns:
+ year (YYYY)  <- factor
+ month (1-12) <- factor
+ time (HH:MM) <- time
+ hour (of day) <- factor
+ day_part (Morning, Afternoon, Evening, Night) <- factor
+ season (Spring, Summer, Fall, Winter) <- factor

```{r Clean_data}
df$INCDATE <- as.Date(df$INCDATE)
df$year <- as.factor(lubridate::year(as.Date(df$INCDATE)))
df$month <- as.factor(lubridate::month(as.Date(df$INCDATE)))
df$time <- as.POSIXct(word(df$INCDTTM, 2), format = '%H:%M')
df$hour <- as.integer(substr(df$time, 12, 13))
df <- df %>%
    mutate(., day_part = with(., case_when(
        (hour >= 6  & hour < 12) ~ 'Morning',
        (hour >= 12 & hour < 17) ~ 'Afternoon',
        (hour >= 17 & hour < 20) ~ 'Evening',
        (hour >= 20 | hour < 6 ) ~ 'Night',
        is.na(hour) ~ 'Unknown',
        TRUE ~ 'Unknown'
    )))
df$hour <- as.factor(df$hour)

df$day_part <- factor(df$day_part)

df <- df %>%
    mutate(., season = with(., case_when(
        (month %in% c('3','4','5'))   ~ 'Spring',
        (month %in% c('6','7','8'))   ~ 'Summer',
        (month %in% c('9','10','11')) ~ 'Fall',
        (month %in% c('12','1','2'))  ~ 'Winter',
        is.na(hour) ~ 'Unknown',
        TRUE ~ 'Unknown'
        )))
df$season <- factor(df$season)
```


### Simplify, create groups, and standardize

#### Rename columns
* UNDERINFL -> DUI

* INATTENTIONID -> DISTRACTED
```{r}
### TODO: move cleaning step transparency to project documentation
### I was not convinced I could substitute 'inattentionind' to 'distracted', because there is a subtle difference and I did not want to be misleading. Then I read the WADOT's 2015 Annual Collision Summary, which (unless they are listing the details of the type of inattention/distraction, which are not available in the downloaded dataset), refer to 'inattention' as 'inattention/distraction', every time. This suggests that I can safely substitute 'distracted' for easier reading of this report.

### Also, I was unsure whether I could use the 'DUI' alias for 'UNDERINFL'. In the same report, 'UNDERINFL' is short for 'Under the Influence of Alcohol and/or Drugs' and, without more detailed data available, is lumped together as ' DUI and/or Physical Control of the Vehicle while under the Influence'. 

### References: 
### https://www.wsdot.wa.gov/mapsdata/crash/pdf/2015_Annual_Collision_Summary.pdf
### https://www.seattle.gov/Documents/Departments/SDOT/About/DocumentLibrary/Reports/2017_Traffic_Report.pdf

# rename columns
df <- setnames(df,
               old=c('UNDERINFL', 'INATTENTIONIND'),
               new=c('DUI'      , 'DISTRACTED'),
               skip_absent = TRUE)
```


#### Create classification column(s)
```{r}
# Using SDOT Collision Code Matrix https://github.com/leaherb/Seattle-Collisions/blob/master/Collisions_OD.pdf
# Striking (the one doing)
df <- df %>%
    mutate(., SDOT_striking = with(., case_when(
        (SDOT_COLCODE == 1)   ~ 'Pedestrian',
        (SDOT_COLCODE == 2)   ~ 'Motor Vehicle',
        (SDOT_COLCODE == 3)   ~ 'Pedalcyclist',
        (SDOT_COLCODE >= 4 & SDOT_COLCODE <= 6)   ~ 'Train',
        (SDOT_COLCODE >= 10 & SDOT_COLCODE <= 29) ~ 'Motor Vehicle',
        (SDOT_COLCODE >= 30 & SDOT_COLCODE <= 49) ~ 'Driverless Motor Vehicle',
        (SDOT_COLCODE >= 50 & SDOT_COLCODE <= 69) ~ 'Pedalcyclist',
        is.na(SDOT_COLCODE) ~ 'Motor Vehicle',
        TRUE ~ 'Unknown / Not applicable'
        )))
# validate 
print_value_counts(df, 'SDOT_striking')

# Struck (the one getting struck); Note: Pedestrian includes Pedalcyclist not in traffic
df <- df %>%
    mutate(., SDOT_struck = with(., case_when(
        (SDOT_COLCODE == 1 | SDOT_COLCODE == 3 | SDOT_COLCODE == 4 )   ~ 'Motor Vehicle',
        (SDOT_COLCODE == 2 | SDOT_COLCODE == 5)   ~ 'Driverless Motor Vehicle',
        (SDOT_COLCODE == 6)                       ~ 'Pedalcyclist',
        (SDOT_COLCODE >= 7 & SDOT_COLCODE <= 8)   ~ 'Pedestrian', 
        (SDOT_COLCODE >= 10 & SDOT_COLCODE <= 16) ~ 'Motor Vehicle',
        (SDOT_COLCODE >= 17 & SDOT_COLCODE <= 23) ~ 'Pedalcyclist',
        (SDOT_COLCODE >= 17 & SDOT_COLCODE <= 23) ~ 'Pedalcyclist',
        (SDOT_COLCODE == 24 | SDOT_COLCODE == 44 | SDOT_COLCODE == 64) ~ 'Pedestrian',
        (SDOT_COLCODE == 25 | SDOT_COLCODE == 45 | SDOT_COLCODE == 65) ~ 'Train',
        (SDOT_COLCODE == 26 | SDOT_COLCODE == 46 | SDOT_COLCODE == 66) ~ 'Object in Roadway',
        (SDOT_COLCODE == 27 | SDOT_COLCODE == 47 | SDOT_COLCODE == 67) ~ 'Non Collision',
        (SDOT_COLCODE == 28 | SDOT_COLCODE == 48 | SDOT_COLCODE == 68) ~ 'Fixed Object',
        (SDOT_COLCODE == 29 | SDOT_COLCODE == 49 | SDOT_COLCODE == 69) ~ 'Non Collision',
        (SDOT_COLCODE >= 30 & SDOT_COLCODE <= 36) ~ 'Motor Vehicle',
        (SDOT_COLCODE >= 37 & SDOT_COLCODE <= 43) ~ 'Pedalcyclist',
        (SDOT_COLCODE >= 50 & SDOT_COLCODE <= 56) ~ 'Motor Vehicle',
        (SDOT_COLCODE >= 57 & SDOT_COLCODE <= 63) ~ 'Pedalcyclist',
        (SDOT_COLCODE >= 70 & SDOT_COLCODE <= 86) ~ 'Pedestrian',
        is.na(SDOT_COLCODE) ~ 'Motor Vehicle',
        TRUE ~ 'Unknown / Not applicable'
        )))
# validate 
print_value_counts(df, 'SDOT_struck')

# validate striking and struck together
df %>%
    group_by(SDOT_striking, SDOT_struck) %>%
    summarise(count = n())


# Group common SDOTtypes (e.g., combine 8 '%Sideswipe%' types into one 'Sideswipe')
# (Ref: State Collision Code Directory https://www.seattle.gov/Documents/Departments/SDOT/GIS/Collisions_OD.pdf)
df <- df %>%
    mutate(., ST_COLDESC_grouped = with(., case_when(
        (ST_COLCODE <= 5) ~ 'Vehicle Hits Pedestrian',
        (ST_COLCODE == 10) ~ 'Entering at angle',   # over 30k in this group
        (ST_COLCODE >= 11 & ST_COLCODE <= 12) ~ 'Sideswipe',
        (ST_COLCODE >= 13 & ST_COLCODE <= 14) ~ 'Rear End',
        (ST_COLCODE >= 15 & ST_COLCODE <= 23) ~ 'From Same Direction',
        (ST_COLCODE >= 24 & ST_COLCODE <= 25) ~ 'Head On',
        (ST_COLCODE >= 26 & ST_COLCODE <= 27) ~ 'Sideswipe',
        (ST_COLCODE >= 28 & ST_COLCODE <= 30) ~ 'From Opposite Direction',
        (ST_COLCODE == 32) ~ 'One parked--one moving',   # over 40k in this group
        (ST_COLCODE >= 44 & ST_COLCODE <= 46) ~ 'Pedalcyclist',
        (ST_COLCODE >= 47 & ST_COLCODE <= 51) ~ 'Struck Object',
        (ST_COLCODE >= 53 & ST_COLCODE <= 57) ~ 'Non-Collision',
        (ST_COLCODE >= 71 & ST_COLCODE <= 72) ~ 'Sideswipe',
        (ST_COLCODE >= 73 & ST_COLCODE <= 74) ~ 'Rear End',
        (ST_COLCODE >= 81 & ST_COLCODE <= 82) ~ 'Sideswipe',
        (ST_COLCODE >= 83 & ST_COLCODE <= 84) ~ 'Rear End',
        is.na(ST_COLCODE) ~ 'Unknown',
        TRUE ~ 'Other Collision'
    )))

# validate 
print_value_counts(df, 'ST_COLDESC_grouped')


# State's interpretation of Striking (the one doing)
df <- df %>%
    mutate(., ST_striking = with(., case_when(
        (ST_COLCODE >= 0 & ST_COLCODE <= 5)   ~ 'Vehicle',
        (ST_COLCODE >= 6 & ST_COLCODE <= 8)   ~ 'Pedalcyclist',
        (ST_COLCODE >= 10 & ST_COLCODE <= 30) ~ 'Vehicle',
        (ST_COLCODE == 31)   ~ 'Not Stated',
        (ST_COLCODE == 32)   ~ 'Vehicle',
        (ST_COLCODE == 40 | ST_COLCODE == 42 | ST_COLCODE == 43)  ~ 'Railway Vehicle',
        (ST_COLCODE == 41)   ~ 'Vehicle',
        (ST_COLCODE >= 45 & ST_COLCODE <= 52)  ~ 'Vehicle',
        (ST_COLCODE >= 53 & ST_COLCODE <= 57)  ~ 'Not applicable',
        (ST_COLCODE == 60 | ST_COLCODE <= 62 | ST_COLCODE <= 64 | ST_COLCODE <= 66) ~ 'Vehicle',
        (ST_COLCODE == 61 | ST_COLCODE <= 63 | ST_COLCODE <= 65 | ST_COLCODE <= 67) ~ 'Road or Construction Machinery',
        (ST_COLCODE >= 71 & ST_COLCODE <= 88)  ~ 'Vehicle',
        is.na(ST_COLCODE) ~ 'Unknown',
        TRUE ~ 'Other'
    )))

# State's interpretation of Struck (the one struck)
df <- df %>%
    mutate(., ST_struck = with(., case_when(
        (ST_COLCODE >= 0 & ST_COLCODE <= 5)   ~ 'Pedestrian',
        (ST_COLCODE == 6)   ~ 'Moving Vehicle',
        (ST_COLCODE == 7)   ~ 'Pedalcyclist or Pedestrian',
        (ST_COLCODE == 8)   ~ 'Other',
        (ST_COLCODE >= 10 & ST_COLCODE <= 30) ~ 'Vehicle',
        (ST_COLCODE == 31)   ~ 'Not Stated',
        (ST_COLCODE == 32)   ~ 'Vehicle',
        (ST_COLCODE == 40)   ~ 'Vehicle',
        (ST_COLCODE == 41)   ~ 'Railway Vehicle',
        (ST_COLCODE >= 42 & ST_COLCODE <= 45)  ~ 'Pedestrian or Pedalcyclist',
        (ST_COLCODE >= 48 & ST_COLCODE <= 51)  ~ 'Animal or Object',
        (ST_COLCODE >= 52 & ST_COLCODE <= 57)  ~ 'Not applicable',
        (ST_COLCODE >= 60 & ST_COLCODE <= 62 | ST_COLCODE <= 64 | ST_COLCODE <= 66) ~ 'Road or Construction Machiner',
        (ST_COLCODE >= 61 & ST_COLCODE <= 63 | ST_COLCODE <= 65 | ST_COLCODE <= 67) ~ 'Vehicle',
        (ST_COLCODE >= 71 & ST_COLCODE <= 84)  ~ 'Vehicle',
        (ST_COLCODE >= 85 & ST_COLCODE <= 87)  ~ 'Animal or Object',
        (ST_COLCODE == 88)   ~ 'Vehicle',
        is.na(ST_COLCODE) ~ 'Unknown',
        TRUE ~ 'Other'
    )))

df %>% filter(!is.na(ST_COLDESC)) %>%
    group_by(ST_COLCODE, ST_COLDESC) %>%
    summarise(count = n())

df %>% 
    group_by(ST_striking, ST_struck, ST_COLDESC_grouped) %>%
    summarise(count = n())

```

* Shorten SEVERITYDESC values by removing ' Collision' from strings
* Clean binary variables so all values are either Y or N. Change NULL to N by default, meaning that the attribute was NOT (='N') marked as a feature of the collision
* Change SEVERITYCODE to 0 where NULL
* Change factors to 'Unknown' where NULL (WEATHER, ROADCOND, LIGHTCOND)






```{r}
# shorten SEVERITYDESC values by removing ' Collision' from strings
df$SEVERITYDESC <- as.factor(gsub('* Collision', '\\1', df$SEVERITYDESC))

# binary-ize DUI (Y/N) 
df <- df %>%
    mutate(., DUI = with(., case_when(
        DUI == '0' ~ 'N',
        DUI == 'N' ~ 'N',
        DUI == '1' ~ 'Y',
        DUI == 'Y' ~ 'Y',
        is.na(DUI) ~ 'N'
    )))

# binary columns: default NULL to 'N'
cols <- c('DUI','DISTRACTED','SPEEDING','HITPARKEDCAR')
# must change factors to characters before replace_na
df[cols] <- lapply(df[cols], as.character)
df <- df %>%
    mutate_at(vars(DUI, DISTRACTED, SPEEDING, HITPARKEDCAR),
              ~replace_na(., 'N'))
df[cols] <- lapply(df[cols], as.factor)


# factor columns: default NULL to 'Unknown'
cols <- c('WEATHER','ROADCOND','LIGHTCOND', 'COLLISIONTYPE', 'JUNCTIONTYPE', 'ADDRTYPE')
# must change factors to characters before replace_na
df[cols] <- lapply(df[cols], as.character)
# TODO: get list of vars from cols list
df <- df %>%
    mutate_at(vars(WEATHER, ROADCOND, LIGHTCOND, COLLISIONTYPE, JUNCTIONTYPE, ADDRTYPE),
              ~replace_na(., 'Unknown'))

df[cols] <- lapply(df[cols], as.factor)
```


### Fix and trim
* Delete the first record by INCDATE (it appears to have been a test insert)
* Change NULL SEVERITYCODE to 0
* Remove columns not of interest at this time
```{r}
# delete first (test) record from 2003
df <- subset(df, year != '2003')

# change NULL SEVERITYCODE to 0
df$SEVERITYCODE[is.na(df$SEVERITYCODE)] <- 0

# remove columns not of interest at this time
df <- df %>%
    select(-OBJECTID, -REPORTNO, -STATUS, -EXCEPTRSNCODE, -EXCEPTRSNDESC,
           -COLDETKEY, -INCKEY, -INTKEY, -SDOTCOLNUM, -SEGLANEKEY, -CROSSWALKKEY, 
           -PEDROWNOTGRNT, -LOCATION, -HITPARKEDCAR, -ST_COLCODE, -ST_COLDESC,
           -SDOT_COLDESC)

# Verify
print_date_range(df)
```


### Data structure after cleaning
```{r}
glimpse(df)
# Any lingering NULLs?
print_null_count(df)
```

#\
Save data to file, retaining the data structure
```{r}
save(df, file = '../data/collisions_clean.rda')
```